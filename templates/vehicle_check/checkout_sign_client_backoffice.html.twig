{% extends 'base2.html.twig' %}

{% block title %}Signature Client (Remise) - État des Lieux Retour #{{ contract.id }}{% endblock %}

{% block stylesheets %}
<!-- Font Awesome -->
<link href="{{ asset('admin/vendors/font-awesome/css/font-awesome.min.css') }}" rel="stylesheet">
<link href="{{ asset('css/admin/detail.css') }}" rel="stylesheet">
<style>
    .signature-canvas-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: #fff;
        padding: 10px;
        margin-bottom: 15px;
    }

    .signature-canvas-container canvas {
        width: 100%;
        height: 200px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    .confirmation-checkbox {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        border: 2px solid #6c757d;
        margin-bottom: 20px;
    }

    .confirmation-checkbox label {
        cursor: pointer;
        font-weight: 500;
    }

    .confirmation-checkbox input[type="checkbox"] {
        transform: scale(1.3);
        margin-right: 10px;
    }
</style>
{% endblock %}

{% block current_page %}
<div class="text-warning">
    <i class="fa fa-user"></i>
    Signature Client (Remise sur place)
    <br>
    <span>Résa: {{ contract.reservation.reference }}</span>
</div>
{% endblock %}

{% block current_page_right %}
<div class="font-weight-bold">
    <span class="text-info">
        <i class="fa fa-dashboard"></i>
        Tableau de bord
    </span>
    > <a href="{{ path('reservation_show', {'id': contract.reservation.id}) }}">Détail réservation</a>
    > Signature Client (Remise)
</div>
{% endblock %}

{% block content %}
<div class="x_panel">
    <div class="x_title">
        <h2>
            <i class="fa fa-user"></i> Signature Client en Backoffice - État des Lieux Retour (Remise) #{{ contract.id
            }}
        </h2>
        <div class="clearfix"></div>
    </div>
    <div class="x_content">
        {# Alertes #}
        {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
        {% endfor %}

        {# Informations #}
        <div class="row mb-4">
            <div class="col-md-6">
                <h5><i class="fa fa-info-circle mr-1"></i>Informations de la réservation</h5>
                <ul class="list-unstyled">
                    <li><strong>Référence:</strong> {{ contract.reservation.reference }}</li>
                    <li><strong>Client:</strong> {{ contract.reservation.client.prenom }} {{
                        contract.reservation.client.nom }}</li>
                    <li><strong>Email:</strong> {{ contract.reservation.client.mail }}</li>
                    <li><strong>Véhicule:</strong> {{ contract.reservation.vehicule.marque }} {{
                        contract.reservation.vehicule.modele }} ({{ contract.reservation.vehicule.immatriculation }})
                    </li>
                    <li><strong>Statut Départ:</strong> <span class="badge badge-success">SIGNÉ</span></li>
                </ul>
            </div>
            <div class="col-md-6 text-right">
                {# Afficher si l'admin a déjà signé le retour #}
                {% if is_signed_by_admin %}
                <div class="alert alert-success">
                    <i class="fa fa-check-circle mr-1"></i>
                    <strong>Signature Admin (Retour) :</strong> Déjà effectuée
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fa fa-info-circle mr-1"></i>
                    <strong>Signature Admin (Retour) :</strong> En attente
                </div>
                {% endif %}
            </div>
        </div>

        <hr>

        {# Zone de Signature #}
        {% if not is_signed_by_client %}
        <div class="signature-section mt-4">
            <div class="x_title">
                <h4><i class="fa fa-pencil mr-1"></i>Signature du Client (Remise effectuée en présence de
                    l'administrateur)
                </h4>
                <div class="clearfix"></div>
            </div>

            <p class="text-muted mb-3">
                Le client doit signer ci-dessous pour valider le retour du véhicule.
            </p>

            <form method="post" action="{{ path('vehicle_checkout_sign_process', {id: contract.id}) }}">
                <input type="hidden" name="signature_type" value="client">
                {% include 'contract/_signature_pad.html.twig' %}

                {# Confirmation obligatoire #}
                <div class="confirmation-checkbox">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="confirm_backoffice" id="confirmBackoffice"
                            value="1" required>
                        <label class="form-check-label" for="confirmBackoffice">
                            <i class="fa fa-hand-paper-o mr-1"></i>
                            <!-- Je confirme que le client <strong>{{ contract.reservation.client.prenom }} {{
                                contract.reservation.client.nom }}</strong>
                            est physiquement présent et signe ce retour en ma présence. -->

                            Je certifie avoir vérifié l'identité du client Joel JOEL, physiquement présent. Le client
                            déclare avoir pris connaissance et accepté sans réserve l'intégralité des conditions
                            générales et particulières de cette location. Il reconnaît expressément que sa signature
                            électronique vaut consentement irrévocable et possède la même valeur juridique qu'une
                            signature manuscrite.
                        </label>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-warning btn-lg">
                        <i class="fa fa-user-check mr-1"></i> Enregistrer la Signature Client (Retour)
                    </button>
                    <a href="{{ path('reservation_show', {'id': contract.reservation.id}) }}"
                        class="btn btn-secondary btn-lg ml-2">
                        <i class="fa fa-arrow-left mr-1"></i> Retour
                    </a>
                </div>
            </form>
        </div>
        {% else %}
        <div class="alert alert-success text-center py-4">
            <h4><i class="fa fa-check-circle mr-1"></i> Signature Client Déjà Enregistrée</h4>
            <p class="mb-0">Le client a déjà signé l'état des lieux de retour.</p>
            <a href="{{ path('reservation_show', {'id': contract.reservation.id}) }}" class="btn btn-primary mt-3">
                <i class="fa fa-arrow-left mr-1"></i> Retour aux détails de la réservation
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}