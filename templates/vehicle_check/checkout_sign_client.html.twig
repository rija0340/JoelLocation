{% extends 'baseClient2.html.twig' %}

{% block title %}Signature État des Lieux - Retour #{{ contract.id }}{% endblock %}

{% block stylesheets %}
<style>
    .modern-card {
        background: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .signature-pad-container {
        border: 2px dashed #e2e8f0;
        transition: all 0.3s ease;
    }

    .signature-pad-container:hover {
        border-color: #e53e3e;
        background-color: #fff5f5;
    }

    .status-card {
        transition: all 0.3s ease;
    }

    .status-card.active {
        border-left: 4px solid #e53e3e;
    }

    .btn-primary {
        background-color: #e53e3e;
        transition: all 0.3s ease;
    }

    .btn-primary:hover {
        background-color: #c53030;
        transform: translateY(-2px);
        box-shadow: 0 6px 12px rgba(229, 62, 62, 0.25);
    }

    .btn-secondary {
        background-color: #2d3748;
        transition: all 0.3s ease;
    }

    .btn-secondary:hover {
        background-color: #1a202c;
        transform: translateY(-2px);
    }

    .security-footer {
        background-color: #2d3748;
        color: #cbd5e0;
    }
</style>
{% endblock %}

{% block body %}
<div class="min-h-screen py-8 bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="modern-card rounded-2xl overflow-hidden mb-8">
            <!-- Header -->
            <div class="bg-black px-8 py-10 text-center">
                <h1 class="text-3xl font-bold mb-2 text-white uppercase tracking-wide flex items-center justify-center">
                    <i class="fa fa-undo mr-3 text-joel-red"></i>Signature État des Lieux - Retour
                </h1>
                <div class="flex items-center justify-center gap-4 mt-4">
                    <p class="text-gray-300 font-medium text-sm">CONTRAT #{{ contract.id }}</p>
                    <span class="w-1 h-1 bg-gray-600 rounded-full"></span>
                    <p class="text-gray-300 font-medium text-sm">RÉSERVATION {{ contract.reservation.reference }}</p>
                </div>
            </div>

            <div class="p-6 md:p-8">
                {# Flash Messages #}
                {% for message in app.flashes('error') %}
                <div class="mb-6 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 rounded-lg" role="alert">
                    <div class="flex items-center">
                        <i class="fa fa-exclamation-triangle mr-2 text-red-500"></i>
                        <div class="font-medium">{{ message }}</div>
                    </div>
                </div>
                {% endfor %}

                {% for message in app.flashes('success') %}
                <div class="mb-6 p-4 bg-green-50 border-l-4 border-green-500 text-green-700 rounded-lg" role="alert">
                    <div class="flex items-center">
                        <i class="fa fa-check-circle mr-2 text-green-500"></i>
                        <div class="font-medium">{{ message }}</div>
                    </div>
                </div>
                {% endfor %}

                {# Status Summary #}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <!-- Client Status -->
                    <div
                        class="status-card rounded-xl p-5 border {{ is_signed_by_client ? 'active bg-green-50 border-green-100' : 'bg-gray-50 border-gray-100' }}">
                        <h3 class="text-sm font-bold flex items-center mb-3 text-gray-600 uppercase tracking-wide">
                            <i
                                class="fa fa-user-circle mr-2 {{ is_signed_by_client ? 'text-green-500' : 'text-gray-400' }}"></i>
                            Ma Signature (Retour)
                        </h3>
                        {% if is_signed_by_client %}
                        {% set clientSig = contract.signatures|filter(s => s.documentType == 'checkout' and
                        s.signatureType == 'client')|first %}
                        <p class="text-sm text-gray-800 font-bold">
                            <i class="fa fa-check-circle mr-1 text-green-500"></i> RETOUR SIGNÉ
                        </p>
                        <p class="text-xs text-gray-500 mt-1">{{ clientSig.signedAt|date('d/m/Y à H:i') }}</p>
                        {% else %}
                        <p class="text-sm text-gray-700 font-medium">
                            <i class="fa fa-clock-o mr-1 text-joel-red"></i> Signature Requise
                        </p>
                        {% endif %}
                    </div>

                    <!-- Departure Status (Prerequisite) -->
                    <div class="status-card rounded-xl p-5 border active bg-green-50 border-green-100">
                        <h3 class="text-sm font-bold flex items-center mb-3 text-gray-600 uppercase tracking-wide">
                            <i class="fa fa-check-circle mr-2 text-green-500"></i>
                            État des Lieux Départ
                        </h3>
                        <p class="text-sm text-gray-800 font-bold">
                            <i class="fa fa-check-circle mr-1 text-green-500"></i> DÉJÀ VALIDÉ
                        </p>
                    </div>
                </div>

                {# Reservation Quick Info #}
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                    <div class="bg-gray-50 rounded-xl p-5 flex items-center">
                        <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center mr-4 text-gray-500">
                            <i class="fa fa-hashtag text-lg"></i>
                        </div>
                        <div>
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Référence</span>
                            <p class="text-lg font-bold text-gray-900">{{ contract.reservation.reference }}</p>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-xl p-5 flex items-center">
                        <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center mr-4 text-gray-500">
                            <i class="fa fa-car text-lg"></i>
                        </div>
                        <div class="text-sm">
                            <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">Véhicule</span>
                            <p class="font-bold text-gray-900">
                                {{ contract.reservation.vehicule.marque }} {{
                                contract.reservation.vehicule.modele }}
                                <span class="text-xs bg-gray-200 px-2 py-0.5 rounded ml-1">
                                    {{ contract.reservation.vehicule.immatriculation }}
                                </span>
                            </p>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-100 mb-10">

                {# Signature Section #}
                {% if not is_signed_by_client %}
                <div class="bg-black rounded-2xl p-8 text-center">
                    <div class="text-center mb-8">
                        <h2 class="text-2xl font-bold text-white mb-2 uppercase tracking-wide">Apposer votre signature
                            (Retour)
                        </h2>
                        <p class="text-gray-300 max-w-md mx-auto">
                            Signez simplement dans le cadre ci-dessous pour valider le retour du véhicule.
                        </p>
                    </div>

                    <form method="post"
                        action="{{ hashedId is defined and hashedId ? path('client_checkout_sign_process_hash', {hashedId: hashedId}) : path('client_checkout_sign_process', {id: contract.reservation.id}) }}"
                        class="space-y-8">
                        <input type="hidden" name="signature_type" value="client">
                        <div class="signature-pad-container p-4 rounded-xl inline-block mx-auto w-full max-w-[532px]">
                            {% include 'contract/_signature_pad.html.twig' %}
                        </div>

                        <div class="flex flex-col sm:flex-row gap-4 justify-center max-w-md mx-auto">
                            <a href="{{ hashedId is defined and hashedId ? path('client_reservation_signature_hash', {'hashedId': hashedId}) : path('client_reservation_show', {'id': contract.reservation.id}) }}"
                                class="flex-1 px-6 py-3 rounded-lg font-bold text-white bg-gray-700 hover:bg-gray-600 transition-all uppercase text-sm">
                                <i class="fa fa-arrow-left mr-2"></i>Retour
                            </a>

                            <button type="submit"
                                class="flex-1 px-6 py-3 rounded-lg font-bold text-white btn-primary uppercase text-sm btn-submit-signature">
                                <i class="fa fa-file-signature mr-2"></i>Signer & Valider le Retour
                            </button>
                        </div>
                    </form>
                </div>
                {% else %}
                {% set clientSig = contract.signatures|filter(s => s.documentType == 'checkout' and s.signatureType ==
                'client')|first %}
                <div class="bg-green-50 border border-green-100 rounded-2xl p-10 text-center">
                    <div
                        class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-green-100 text-green-600 mb-6 p-4">
                        <i class="fa fa-check-double text-4xl"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900 mb-3 uppercase tracking-wide">Retour Signé !</h2>
                    <p class="text-gray-600 mb-4 max-w-md mx-auto">
                        Votre signature pour le retour a été enregistrée avec succès le
                        <span class="font-bold text-gray-800">{{ clientSig.signedAt|date('d/m/Y à H:i') }}</span>.
                    </p>

                    <div class="mb-8">
                        {% if clientSig.ipAddress is defined and '[BACKOFFICE]' in clientSig.ipAddress %}
                        <span
                            class="inline-block text-sm bg-orange-100 text-orange-700 px-4 py-2 rounded-full font-medium">
                            <i class="fa fa-building mr-2"></i> Signature effectuée en agence
                        </span>
                        {% else %}
                        <span class="inline-block text-sm bg-blue-100 text-blue-700 px-4 py-2 rounded-full font-medium">
                            <i class="fa fa-laptop mr-2"></i> Signature effectuée depuis votre espace client
                        </span>
                        {% endif %}
                    </div>

                    <div class="flex flex-wrap gap-4 justify-center">
                        <a href="{{ hashedId is defined and hashedId ? path('client_reservation_signature_hash', {'hashedId': hashedId}) : path('client_reservation_show', {'id': contract.reservation.id}) }}"
                            class="px-6 py-3 bg-white border border-gray-300 rounded-lg font-bold text-gray-800 hover:bg-gray-50 transition-all uppercase text-sm">
                            <i class="fa fa-arrow-left mr-2"></i>Retour
                        </a>
                        <a href="{{ path('client_vehicle_check_summary_hash', {hashedId: hashedId|default(contract.reservation.id|sha1)}) }}"
                            class="px-6 py-3 btn-secondary text-white rounded-lg font-bold text-sm hover:opacity-90 transition-all uppercase">
                            <i class="fa fa-clipboard-list mr-2"></i>Voir le Récapitulatif
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Help / Security Footer -->
        <div class="security-footer rounded-xl p-4 text-center text-sm mt-8">
            <div class="flex flex-col md:flex-row items-center justify-center gap-4">
                <div class="flex items-center">
                    <i class="fa fa-shield-alt mr-2"></i> Signature sécurisée certifiée eIDAS
                </div>
                <div class="flex gap-4">
                    <span><i class="fa fa-map-marker-alt mr-1"></i> IP TRACÉE</span>
                    <span><i class="fa fa-clock mr-1"></i> HORODATAGE</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
    // Visual feedback for signature submission
    document.querySelector('form')?.addEventListener('submit', function () {
        const btn = this.querySelector('.btn-submit-signature');
        if (btn) {
            btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> Traitement...';
            btn.disabled = true;
            btn.classList.add('opacity-75', 'cursor-not-allowed');
        }
    });
</script>
{% endblock %}