{% extends 'base2.html.twig' %}

{% block title %}Test Disponibilité Véhicules{% endblock %}

{% block current_page %}
    <h2><i class="fa fa-car"></i> Tests Disponibilité</h2>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2>Test de Disponibilité des Véhicules <small>Réservations et Stop Sales</small></h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <p class="text-muted">
                    Cette interface permet de tester la logique de recherche des véhicules disponibles 
                    en tenant compte des <strong>réservations</strong> ET des <strong>stop sales</strong>.
                </p>

                {% for message in app.flashes('success') %}
                    <div class="alert alert-success alert-dismissible fade in">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        {{ message }}
                    </div>
                {% endfor %}
                
                {% for message in app.flashes('error') %}
                    <div class="alert alert-danger alert-dismissible fade in">
                        <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Search Form -->
    <div class="col-md-4 col-sm-12 col-xs-12">
        <div class="x_panel">
            <div class="x_title">
                <h2><i class="fa fa-search"></i> Paramètres de Recherche</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <form method="post" action="{{ path('availability_testing_check') }}">
                    <div class="form-group">
                        <label for="date_debut">Date de Début</label>
                        <input type="datetime-local" 
                               class="form-control" 
                               id="date_debut" 
                               name="date_debut" 
                               value="{{ date_debut|default('') }}"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="date_fin">Date de Fin</label>
                        <input type="datetime-local" 
                               class="form-control" 
                               id="date_fin" 
                               name="date_fin" 
                               value="{{ date_fin|default('') }}"
                               required>
                    </div>
                    <div class="form-group">
                        <label for="vehicle_id">Véhicule spécifique (optionnel)</label>
                        <select class="form-control" id="vehicle_id" name="vehicle_id">
                            <option value="">-- Tous les véhicules --</option>
                            {% for vehicle in vehicles %}
                                <option value="{{ vehicle.id }}" 
                                        {{ selected_vehicle_id|default('') == vehicle.id ? 'selected' : '' }}>
                                    {{ vehicle.immatriculation }} - {{ vehicle.marque.libelle }} {{ vehicle.modele.libelle }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fa fa-search me-2"></i> Vérifier Disponibilité
                    </button>
                </form>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="x_panel">
            <div class="x_title">
                <h2><i class="fa fa-link"></i> Liens Rapides</h2>
                <div class="clearfix"></div>
            </div>
            <div class="x_content">
                <a href="{{ path('availability_testing_blocking_entries') }}" class="btn btn-default btn-block mb-2">
                    <i class="fa fa-list me-1"></i> Voir Entrées Bloquantes
                </a>
                <a href="{{ path('stop_sales') }}" class="btn btn-warning btn-block mb-2">
                    <i class="fa fa-ban me-1"></i> Gestion Stop Sales
                </a>
                <a href="{{ path('testing_home') }}" class="btn btn-info btn-block">
                    <i class="fa fa-arrow-left me-1"></i> Retour au Testing Hub
                </a>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div class="col-md-8 col-sm-12 col-xs-12">
        {% if results is defined %}
            <!-- Summary -->
            <div class="row tile_count">
                <div class="col-md-3 col-sm-6 col-xs-6 tile_stats_count">
                    <span class="count_top"><i class="fa fa-car"></i> Total Véhicules</span>
                    <div class="count">{{ results.total_vehicles }}</div>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-6 tile_stats_count">
                    <span class="count_top"><i class="fa fa-check text-success"></i> Disponibles</span>
                    <div class="count green">{{ results.available_count }}</div>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-6 tile_stats_count">
                    <span class="count_top"><i class="fa fa-times text-danger"></i> Indisponibles</span>
                    <div class="count red">{{ results.unavailable_count }}</div>
                </div>
                <div class="col-md-3 col-sm-6 col-xs-6 tile_stats_count">
                    <span class="count_top"><i class="fa fa-ban text-warning"></i> Stop Sales</span>
                    <div class="count" style="color: #f0ad4e;">{{ results.stop_sales_count }}</div>
                </div>
            </div>

            <!-- Period Info -->
            <div class="x_panel">
                <div class="x_content">
                    <div class="alert alert-info">
                        <strong>Période analysée :</strong> 
                        {{ results.date_debut|date('d/m/Y H:i') }} - {{ results.date_fin|date('d/m/Y H:i') }}
                        <br>
                        <small>
                            {{ results.reservations_count }} réservation(s) + {{ results.stop_sales_count }} stop sale(s) = {{ results.total_blocking_entries }} entrée(s) bloquante(s)
                        </small>
                    </div>
                </div>
            </div>

            <!-- Vehicle Details Table -->
            <div class="x_panel">
                <div class="x_title">
                    <h2><i class="fa fa-table"></i> Détails par Véhicule</h2>
                    <div class="clearfix"></div>
                </div>
                <div class="x_content">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered">
                            <thead>
                                <tr class="headings">
                                    <th>Véhicule</th>
                                    <th>Immatriculation</th>
                                    <th>Statut</th>
                                    <th>Détails Blocage</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for vehicle in results.vehicles %}
                                    <tr class="{{ vehicle.is_available ? '' : 'danger' }}">
                                        <td>{{ vehicle.marque }} {{ vehicle.modele }}</td>
                                        <td><code>{{ vehicle.immatriculation }}</code></td>
                                        <td>
                                            {% if vehicle.is_available %}
                                                <span class="label label-success">
                                                    <i class="fa fa-check me-1"></i> Disponible
                                                </span>
                                            {% else %}
                                                <span class="label label-danger">
                                                    <i class="fa fa-times me-1"></i> Indisponible
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if vehicle.blocking_entries|length > 0 %}
                                                {% for entry in vehicle.blocking_entries %}
                                                    <div class="mb-1">
                                                        {% if entry.type == 'stop_sale' %}
                                                            <span class="label label-warning">
                                                                <i class="fa fa-ban me-1"></i> Stop Sale
                                                            </span>
                                                        {% else %}
                                                            <span class="label label-primary">
                                                                <i class="fa fa-calendar me-1"></i> Réservation
                                                            </span>
                                                        {% endif %}
                                                        <small class="text-muted">
                                                            {{ entry.date_debut|date('d/m H:i') }} - {{ entry.date_fin|date('d/m H:i') }}
                                                            {% if entry.reference %}({{ entry.reference }}){% endif %}
                                                        </small>
                                                    </div>
                                                {% endfor %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            {% if vehicle_detail is defined and vehicle_detail %}
                <!-- Specific Vehicle Detail -->
                <div class="x_panel">
                    <div class="x_title">
                        <h2>
                            <i class="fa fa-car"></i>
                            Détail: {{ vehicle_detail.vehicle.immatriculation }} - {{ vehicle_detail.vehicle.marque }} {{ vehicle_detail.vehicle.modele }}
                        </h2>
                        <div class="clearfix"></div>
                    </div>
                    <div class="x_content">
                        <div class="mb-3">
                            <strong>Statut:</strong>
                            {% if vehicle_detail.is_available %}
                                <span class="label label-success" style="font-size: 14px;">DISPONIBLE</span>
                            {% else %}
                                <span class="label label-danger" style="font-size: 14px;">INDISPONIBLE</span>
                            {% endif %}
                        </div>
                        
                        {% if vehicle_detail.blocking_entries|length > 0 %}
                            <h4>Entrées Bloquantes:</h4>
                            <ul class="list-group">
                                {% for entry in vehicle_detail.blocking_entries %}
                                    <li class="list-group-item">
                                        <div class="row">
                                            <div class="col-md-9">
                                                {% if entry.type == 'stop_sale' %}
                                                    <span class="label label-warning me-2">Stop Sale</span>
                                                {% else %}
                                                    <span class="label label-primary me-2">Réservation</span>
                                                {% endif %}
                                                <strong>{{ entry.reference|default('N/A') }}</strong>
                                                <br>
                                                <small class="text-muted">
                                                    {{ entry.date_debut|date('d/m/Y H:i') }} → {{ entry.date_fin|date('d/m/Y H:i') }}
                                                </small>
                                                {% if entry.client %}
                                                    <br><small>Client: {{ entry.client }}</small>
                                                {% endif %}
                                                {% if entry.commentaire %}
                                                    <br><small class="text-info">{{ entry.commentaire }}</small>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-3 text-right">
                                                <span class="label label-default">#{{ entry.id }}</span>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <!-- No Results Yet -->
            <div class="x_panel">
                <div class="x_content text-center" style="padding: 60px 20px;">
                    <i class="fa fa-calendar-o fa-4x text-muted mb-3"></i>
                    <h3>Sélectionnez une Période</h3>
                    <p class="text-muted">
                        Renseignez les dates de début et de fin pour vérifier la disponibilité des véhicules.
                    </p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<style>
    .tile_count .tile_stats_count {
        border-bottom: none;
        padding: 15px;
        text-align: center;
        background: #fff;
        border-radius: 5px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tile_count .count {
        font-size: 32px;
        font-weight: 600;
    }
    .tile_count .count_top {
        font-size: 12px;
        color: #888;
    }
    .green { color: #26B99A; }
    .red { color: #E74C3C; }
    .form-group {
        margin-bottom: 15px;
    }
    .btn-block {
        width: 100%;
        margin-bottom: 5px;
    }
</style>
{% endblock %}
