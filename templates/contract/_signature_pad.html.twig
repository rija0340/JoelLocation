<div class="signature-pad-container bg-white text-center w-full">
    <div class="mb-4 signature-pad-frame mx-auto" style="max-width: 532px;">
        <div class="signature-pad-canvas-wrapper bg-gray-50 p-2 border-2 border-gray-200 rounded-xl">
            <canvas id="signature-pad" class="bg-white mx-auto cursor-crosshair block" width="500" height="200"
                style="touch-action: none; max-width: 100%; border: 1px solid #dee2e6; border-radius: 0.5rem;"></canvas>
        </div>
    </div>
    <div class="flex justify-center flex-wrap gap-3 mb-4 d-flex justify-content-center">
        <button type="button"
            class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-semibold text-gray-700 bg-white hover:bg-gray-50 transition-colors shadow-sm btn btn-outline-secondary"
            id="clear-signature">
            <i class="fa fa-eraser mr-2 text-danger"></i> Effacer
        </button>
        <button type="button"
            class="inline-flex items-center px-4 py-2 border border-joel-red rounded-lg text-sm font-semibold text-joel-red bg-white hover:bg-joel-red hover:text-white transition-all shadow-sm btn btn-outline-primary"
            style="border-color: #af0000; color: #af0000;" id="save-signature">
            <i class="fa fa-save mr-2"></i> Prévisualiser
        </button>
    </div>
    <input type="hidden" name="signature_data" id="signature_data">
    <div>
        <p class="text-xs text-gray-400">
            <i class="fa fa-mouse-pointer mr-1"></i> Utilisez votre souris ou écran tactile pour signer
        </p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var canvas = document.getElementById('signature-pad');
        var signaturePad = new SignaturePad(canvas, {
            backgroundColor: 'rgb(255, 255, 255)',
            penColor: 'rgb(0, 0, 0)',
            minWidth: 0.5,
            maxWidth: 2.5
        });

        // Resize canvas for high DPI screens
        function resizeCanvas() {
            var ratio = Math.max(window.devicePixelRatio || 1, 1);
            var container = canvas.parentElement;
            var width = container.offsetWidth;

            // Limit width if container is very large
            if (width > 500) width = 500;

            canvas.style.width = width + "px";
            canvas.width = width * ratio;
            canvas.height = 200 * ratio; // Keep height fixed
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }

        window.addEventListener("resize", resizeCanvas);
        resizeCanvas();

        document.getElementById('clear-signature').addEventListener('click', function () {
            signaturePad.clear();
            document.getElementById('signature_data').value = '';

            // Visual feedback
            canvas.style.borderColor = '#e5e7eb';
        });

        document.getElementById('save-signature').addEventListener('click', function () {
            if (signaturePad.isEmpty()) {
                alert("Veuillez signer le document avant de continuer.");
            } else {
                var data = signaturePad.toDataURL('image/png');
                document.getElementById('signature_data').value = data;

                // Visual feedback
                canvas.style.borderColor = '#af0000';

                // You could show a small toast or change button text
                const btn = this;
                const originalHtml = btn.innerHTML;
                btn.innerHTML = '<i class="fa fa-check mr-2"></i> Prêt !';
                btn.classList.replace('text-joel-red', 'text-green-600');
                btn.classList.replace('border-joel-red', 'border-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalHtml;
                    btn.classList.replace('text-green-600', 'text-joel-red');
                    btn.classList.replace('border-green-600', 'border-joel-red');
                }, 2000);
            }
        });

        // On form submit, put signature data into hidden input
        var form = canvas.closest('form');
        if (form) {
            form.addEventListener('submit', function (e) {
                if (signaturePad.isEmpty()) {
                    e.preventDefault();

                    // Shake effect on canvas
                    canvas.classList.add('animate-shake');
                    setTimeout(() => canvas.classList.remove('animate-shake'), 500);

                    alert("Veuillez signer le document avant de valider.");
                } else {
                    var data = signaturePad.toDataURL('image/png');
                    document.getElementById('signature_data').value = data;
                }
            });
        }
    });
</script>

<style>
    @keyframes shake {

        0%,
        100% {
            transform: translateX(0);
        }

        25% {
            transform: translateX(-5px);
        }

        75% {
            transform: translateX(5px);
        }
    }

    .animate-shake {
        animation: shake 0.2s ease-in-out 0s 2;
        border-color: #ef4444 !important;
    }

    .signature-pad-canvas-wrapper {
        background-color: #f8f9fa;
        border: 2px solid #e9ecef;
        padding: 8px;
        border-radius: 12px;
        display: inline-block;
        width: 100%;
        box-sizing: border-box;
    }
</style>