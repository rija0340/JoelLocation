{% extends 'base2.html.twig' %}

{% block title %}Validation Admin - Contrat #{{ contract.id }}{% endblock %}

{% block stylesheets %}
<!-- Font Awesome -->
<link href="{{ asset('admin/vendors/font-awesome/css/font-awesome.min.css') }}" rel="stylesheet">
<link href="{{ asset('css/admin/detail.css') }}" rel="stylesheet">
<style>
    .signature-canvas-container {
        border: 2px solid #ddd;
        border-radius: 8px;
        background: #fff;
        padding: 10px;
        margin-bottom: 15px;
    }

    .signature-canvas-container canvas {
        width: 100%;
        height: 200px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
</style>
{% endblock %}

{% block current_page %}
<div class="text-info">
    <i class="fa fa-file-signature"></i>
    Signature Admin - Contrat
    <br>
    <span>Résa: {{ contract.reservation.reference }}</span>
</div>
{% endblock %}

{% block current_page_right %}
<div class="font-weight-bold">
    <span class="text-info">
        <i class="fa fa-dashboard"></i>
        Tableau de bord
    </span>
    > <a href="{{ path('reservation_show', {'id': contract.reservation.id}) }}">Détail réservation</a>
    > Signature Admin
</div>
{% endblock %}

{% block content %}
<div class="x_panel">
    <div class="x_title">
        <h2>
            <i class="fa fa-user-shield"></i> Validation Administrateur - Contrat #{{ contract.id }}
        </h2>
        <div class="clearfix"></div>
    </div>
    <div class="x_content">
        {# Alertes #}
        {% for message in app.flashes('error') %}
        <div class="alert alert-danger">{{ message }}</div>
        {% endfor %}
        {% for message in app.flashes('success') %}
        <div class="alert alert-success">{{ message }}</div>
        {% endfor %}

        {# Informations #}
        <div class="row mb-4">
            <div class="col-md-6">
                <h5><i class="fa fa-info-circle mr-1"></i>Informations du contrat</h5>
                <ul class="list-unstyled">
                    <li><strong>Référence:</strong> {{ contract.reservation.reference }}</li>
                    <li><strong>Client:</strong> {{ contract.reservation.client.prenom }} {{
                        contract.reservation.client.nom }}</li>
                    <li><strong>Email:</strong> {{ contract.reservation.client.mail }}</li>
                    <li><strong>Véhicule:</strong> {{ contract.reservation.vehicule.immatriculation }}</li>
                    <li><strong>Statut actuel:</strong>
                        <span class="badge 
							{% if contract.contractStatus == 'fully_signed' %}badge-success
							{% elseif contract.contractStatus == 'client_signed' %}badge-info
							{% else %}badge-secondary{% endif %}">
                            {{ contract.contractStatus }}
                        </span>
                    </li>
                </ul>
            </div>
            <div class="col-md-6 text-right">
                {# "Pré-requis" section removed #}
            </div>
        </div>

        <hr>

        {# Contenu du contrat #}
        <div class="mb-4">
            <h5><i class="fa fa-file-text mr-1"></i>Contenu du contrat</h5>
            <div class="bg-light p-3 border rounded" style="max-height: 300px; overflow-y: auto;">
                <pre style="white-space: pre-wrap; font-size: 0.9em; margin: 0;">{{ contract.contractContent }}</pre>
            </div>
        </div>

        {# Zone de Signature #}
        {% if not contract.isSignedByAdmin %}
        <div class="signature-section mt-4">
            <div class="x_title">
                <h4><i class="fa fa-pencil mr-1"></i>Signature Administrateur</h4>
                <div class="clearfix"></div>
            </div>

            {% if not contract.isSignedByClient %}
            <div class="alert alert-info mb-3">
                <i class="fa fa-info-circle mr-1"></i>
                Le client n'a pas encore signé ce contrat. Vous pouvez signer en premier.
            </div>
            {% endif %}

            <p class="text-muted mb-3">
                En tant qu'administrateur, validez ce contrat en apposant votre signature.
            </p>

            <form method="post" action="{{ path('contract_sign_admin_process', {id: contract.id}) }}">
                {% include 'contract/_signature_pad.html.twig' %}

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fa fa-stamp mr-1"></i> Valider le Contrat
                    </button>
                    <a href="{{ path('reservation_show', {'id': contract.reservation.id}) }}"
                        class="btn btn-secondary btn-lg ml-2">
                        <i class="fa fa-arrow-left mr-1"></i> Retour
                    </a>
                </div>
            </form>
        </div>
        {% elseif contract.isSignedByAdmin %}
        <div class="alert alert-success text-center py-4">
            <h4><i class="fa fa-check-double mr-1"></i> Contrat Entièrement Validé</h4>
            <p class="mb-0">Ce contrat est finalisé et verrouillé.</p>
            <a href="{{ path('reservation_show', {'id': contract.reservation.id}) }}" class="btn btn-primary mt-3">
                <i class="fa fa-arrow-left mr-1"></i> Retour aux détails de la réservation
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}