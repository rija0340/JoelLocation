<!-- Contract Signature Section -->
<div class="bg-white rounded-lg shadow-md p-6">
    <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
        <i class="fas fa-file-signature text-blue-500 mr-2"></i>
        Signature électronique du contrat
    </h3>

    {% set latestContract = null %}
    {% for contract in reservation.contracts %}
    {% if latestContract is null or contract.createdAt > latestContract.createdAt %}
    {% set latestContract = contract %}
    {% endif %}
    {% endfor %}

    {% if latestContract %}
    {# Contract exists - show status and details #}
    <div class="mb-4">
        <div class="p-4 rounded-lg
        {% if latestContract.contractStatus == 'fully_signed' %}bg-green-100 border border-green-300
        {% elseif latestContract.contractStatus == 'client_signed' %}bg-blue-100 border border-blue-300
        {% elseif latestContract.contractStatus == 'admin_signed' %}bg-yellow-100 border border-yellow-300
        {% else %}bg-gray-100 border border-gray-300{% endif %}">
            <strong class="text-gray-700">Statut du contrat:</strong>
            {% if latestContract.contractStatus == 'fully_signed' %}
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-500 text-white ml-2">
                <i class="fas fa-check-circle mr-1"></i> Complètement signé
            </span>
            {% elseif latestContract.contractStatus == 'client_signed' %}
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-500 text-white ml-2">
                <i class="fas fa-user mr-1"></i> Signé par vous (en attente de validation)
            </span>
            {% elseif latestContract.contractStatus == 'admin_signed' %}
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-500 text-white ml-2">
                <i class="fas fa-clock mr-1"></i> En attente de votre signature
            </span>
            {% else %}
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-500 text-white ml-2">
                <i class="fas fa-hourglass-half mr-1"></i> Non signé
            </span>
            {% endif %}
        </div>
    </div>

    {# Signatures details #}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        {% for signature in latestContract.signatures %}
        <div class="border rounded-lg overflow-hidden
          {% if signature.signatureType == 'client' %}border-blue-400{% else %}border-green-400{% endif %}">
            <div class="px-4 py-2 text-white font-semibold
            {% if signature.signatureType == 'client' %}bg-blue-500{% else %}bg-green-500{% endif %}">
                <i
                    class="fas {% if signature.signatureType == 'client' %}fa-user{% else %}fa-user-tie{% endif %} mr-2"></i>
                Signature {{ signature.signatureType == 'client' ? 'Client' : 'Administrateur' }}
            </div>
            <div class="p-4 bg-white">
                <div class="space-y-2 text-sm">
                    <p class="flex items-center">
                        <i class="fas fa-calendar text-gray-400 mr-2 w-4"></i>
                        <strong class="text-gray-600 mr-1">Date:</strong>
                        <span class="text-gray-800">{{ signature.signedAt|date('d/m/Y H:i:s') }}</span>
                    </p>
                    <p class="flex items-center">
                        <i class="fas fa-check-circle text-gray-400 mr-2 w-4"></i>
                        <strong class="text-gray-600 mr-1">Validité:</strong>
                        {% if signature.signatureValid %}
                        <span class="text-green-600"><i class="fas fa-check"></i> Valide</span>
                        {% else %}
                        <span class="text-red-600"><i class="fas fa-times"></i> Non valide</span>
                        {% endif %}
                    </p>
                    {% if signature.timestampToken %}
                    <p class="flex items-center">
                        <i class="fas fa-clock text-gray-400 mr-2 w-4"></i>
                        <strong class="text-gray-600 mr-1">Horodatage certifié:</strong>
                        <span class="text-green-600"><i class="fas fa-certificate"></i> Oui</span>
                    </p>
                    {% endif %}
                </div>
                {% if signature.signatureImage %}
                <div class="mt-3 pt-3 border-t border-gray-200">
                    <p class="text-sm font-semibold text-gray-600 mb-2">Signature visuelle:</p>
                    <div class="border border-gray-300 rounded p-2 bg-gray-50 inline-block">
                        <img src="{{ signature.signatureImage }}" alt="Signature" class="max-h-20 max-w-full">
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    {# Action buttons #}
    <div class="text-center mt-4">
        {% if not latestContract.isSignedByClient() %}
        <a href="{{ path('contract_sign_client_reservation', {'id': reservation.id}) }}"
            class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-300">
            <i class="fas fa-pen-fancy mr-2"></i>
            Signer le contrat
        </a>
        {% elseif latestContract.contractStatus == 'fully_signed' %}
        <div class="inline-flex items-center px-6 py-3 bg-green-100 text-green-700 font-semibold rounded-lg">
            <i class="fas fa-check-circle mr-2"></i>
            Contrat complètement signé
        </div>
        {% else %}
        <div class="inline-flex items-center px-6 py-3 bg-blue-100 text-blue-700 font-semibold rounded-lg">
            <i class="fas fa-hourglass-half mr-2"></i>
            En attente de la signature administrateur
        </div>
        {% endif %}
    </div>
    {% else %}
    {# No contract yet - show button to create and sign #}
    <div class="text-center py-6">
        <div class="mb-4">
            <i class="fas fa-file-contract text-6xl text-gray-300"></i>
        </div>
        <p class="text-gray-500 mb-4">Aucun contrat électronique n'a encore été créé pour cette réservation.</p>
        <a href="{{ path('contract_sign_client_reservation', {'id': reservation.id}) }}"
            class="inline-flex items-center px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg shadow-md transition duration-300">
            <i class="fas fa-file-signature mr-2"></i>
            Créer et signer le contrat électronique
        </a>
    </div>
    {% endif %}
</div>